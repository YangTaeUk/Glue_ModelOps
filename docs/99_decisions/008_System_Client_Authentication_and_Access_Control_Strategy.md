# ADR-008: 시스템 클라이언트 인증 및 접근 제어 전략

> **Status**: Accepted
> **Date**: 2024-12-28
> **Author**: System Architect
> **Context**: [ADR-001](./001_How_to_Securely_Expose_AI_API_Endpoint_[Nginx%20OSS].md) 후속 결정 — Edge Layer의 보안 기능 구체화
> **Supersedes**: N/A

---

## TL;DR (한 줄 요약)

> Machine-to-Machine 통신 특성을 고려하여, **인증 책임을 Edge Layer(Nginx)에 위임**하고 **Static API Key 방식**을 채택한다. 복잡한 토큰 서버 없이도 "충분히 안전한" 보안 체계를 수립한다.

---

## 1. 문제 정의 (The Problem)

### 1.1 배경/현황

**이 논의가 왜 시작되었는가?**

ADR-001에서 Edge Abstraction Layer(Nginx)를 도입하여 **PEP(정책 집행 지점)** 역할을 부여했다. 그러나 "**누가** 이 시스템에 접근할 수 있는가?"에 대한 구체적인 인증 전략은 정의되지 않았다.

**현재 단계의 특성:**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      우리 플랫폼의 사용자 특성                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  일반적인 웹 서비스          vs        우리 AI 플랫폼                   │
│  ─────────────────────                ───────────────────               │
│                                                                          │
│  사용자: 사람 (End User)              사용자: 시스템 (Machine Client)   │
│  ├─ 브라우저 기반                     ├─ 타 부서 서버                   │
│  ├─ 로그인/로그아웃 필요              ├─ 외부 시스템 연동               │
│  ├─ 세션 관리 필요                    ├─ 자동화된 API 호출              │
│  └─ OAuth2 SSO 가치 있음              └─ 24/7 무인 운영                 │
│                                                                          │
│  ⚠️ End User 대상 인증 패턴을 그대로 적용하면 Over-Engineering         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**MVP/초기 구축 단계의 제약:**

| 제약 | 설명 |
|------|------|
| **팀 규모** | 소규모 (2~5명), 인증 서버 운영 인력 부재 |
| **클라이언트 수** | 초기 10개 미만의 시스템 클라이언트 |
| **시간** | 빠른 초기 구축 우선 |
| **비용** | 추가 인프라 비용 최소화 |

### 1.2 핵심 문제

| 현상 (Symptom) | 본질 (Root Cause) |
|---------------|-------------------|
| 인증 책임 소재 불명확 | Edge vs Backend 역할 분담 미정의 |
| OAuth2 도입 고려 중 | 사용자 유형(Machine vs Human) 미구분 |
| 보안 vs 복잡성 트레이드오프 | "충분히 안전한" 수준 정의 부재 |

### 1.3 비즈니스 임팩트

**해결하지 않으면:**

| 영향 | 설명 |
|------|------|
| **보안 공백** | 인증 없이 노출되거나, 각 서비스가 개별 구현하여 불일치 발생 |
| **과도한 엔지니어링** | Keycloak/OAuth2 서버 구축으로 초기 개발 지연 |
| **운영 부담 증가** | 인증 서버 추가 운영으로 관리 포인트 증가 |
| **감사 추적 어려움** | 요청 주체 식별 불가로 컴플라이언스 증명 곤란 |

---

## 2. 전략적 결정

> **Why/What 원칙**: ADR은 "무엇을" 결정하고, "어떻게"는 설계 문서로 위임한다.

### 2.1 결정 #1: 인증 책임을 Edge Layer에 위임

> **"인증은 Edge에서, 비즈니스 로직은 Backend에서"**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      인증 책임 위임 (Authentication Delegation)          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │   Before: 인증 책임 혼재                                        │    │
│  │   ─────────────────────────                                     │    │
│  │                                                                  │    │
│  │   [Client] ──▶ [Nginx] ──▶ [FastAPI]                            │    │
│  │                   │          │                                   │    │
│  │                   │          ├─ 인증 미들웨어 ❌                 │    │
│  │                   │          ├─ 토큰 검증 ❌                     │    │
│  │                   │          ├─ 비즈니스 로직                    │    │
│  │                   │          └─ 혼재된 관심사                    │    │
│  │                   │                                              │    │
│  │                   └─ TLS만 처리                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│                              ▼ 변경                                     │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │   After: 인증 책임 분리                                         │    │
│  │   ─────────────────────────                                     │    │
│  │                                                                  │    │
│  │   [Client] ──▶ [Nginx] ──────────────────▶ [FastAPI]            │    │
│  │                   │                           │                  │    │
│  │                   ├─ TLS Termination          │                  │    │
│  │                   ├─ API Key 검증 ✅          ├─ 비즈니스 로직만 │    │
│  │                   ├─ Rate Limiting            │  순수하게 유지   │    │
│  │                   ├─ 401/403 반환             │                  │    │
│  │                   └─ X-Client-ID 주입 ✅      └─ 검증된 요청만   │    │
│  │                                                   수신           │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**왜 Edge Layer인가:**

| 근거 | 설명 |
|------|------|
| **성능** | Nginx는 Python 백엔드보다 인증 처리가 월등히 빠름 (C 기반, 이벤트 드리븐) |
| **Defense in Depth** | 잘못된 요청이 애플리케이션 진입 전에 차단됨 |
| **단일 PEP** | ADR-001에서 정의한 정책 집행 지점 역할 강화 |
| **관심사 분리** | Backend는 비즈니스 로직에만 집중 가능 |

**Backend의 책임 변화:**

| Before | After |
|--------|-------|
| 인증 미들웨어 구현 | 인증 로직 제거 |
| 토큰 검증 | X-Client-ID 헤더 신뢰 |
| 401/403 에러 처리 | Edge에서 처리됨 |
| 인증 관련 테스트 | 불필요 |

### 2.2 결정 #2: Static API Key 방식 채택

> **"Machine-to-Machine 통신에는 Static API Key가 적합하다"**

**인증 메커니즘 선택:**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Static API Key 방식 (Bearer Token)                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   [System Client]                              [AI Platform]            │
│        │                                            │                   │
│        │   ① HTTP Request                          │                   │
│        │   Authorization: Bearer <API_KEY>         │                   │
│        │──────────────────────────────────────────▶│                   │
│        │                                            │                   │
│        │                                   ┌────────┴────────┐         │
│        │                                   │ Nginx           │         │
│        │                                   │ ├─ Key 검증     │         │
│        │                                   │ ├─ Client 식별  │         │
│        │                                   │ └─ Header 주입  │         │
│        │                                   └────────┬────────┘         │
│        │                                            │                   │
│        │   ② 200 OK / 401 Unauthorized              │                   │
│        │◀──────────────────────────────────────────│                   │
│        │                                            │                   │
│                                                                          │
│   ─────────────────────────────────────────────────────────────────     │
│                                                                          │
│   API Key 관리:                                                         │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │  • 클라이언트당 고유 Key 발급                                │      │
│   │  • Key-Client 매핑 테이블 관리                              │      │
│   │  • 주기적 Key 로테이션 정책 (분기별 권장)                   │      │
│   │  • 유출 시 즉시 무효화 절차                                 │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                          │
│   (구체적인 Key 생성 규칙과 저장 방식은 설계 문서에서 정의)             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**OAuth2 대비 적합성:**

| 측면 | OAuth2 | Static API Key |
|------|--------|----------------|
| **토큰 수명** | 단기 (1시간 등) | 장기 (분기별 로테이션) |
| **인증 서버** | 필수 (Keycloak 등) | 불필요 |
| **토큰 갱신** | 자동화 필요 | 불필요 |
| **적합한 사용자** | End User (사람) | Machine Client (시스템) |
| **구현 복잡도** | 높음 | 낮음 |
| **초기 구축 비용** | 인증 서버 + 연동 | Nginx 설정만 |

### 2.3 결정 #3: 신원 전파 (Identity Propagation)

> **"Edge에서 인증하고, Backend로 신원을 전달한다"**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      신원 전파 (Identity Propagation)                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   [Client]          [Nginx]               [FastAPI]                     │
│      │                 │                      │                         │
│      │ Authorization:  │                      │                         │
│      │ Bearer xxx123   │                      │                         │
│      │────────────────▶│                      │                         │
│      │                 │                      │                         │
│      │                 │ ① Key 검증           │                         │
│      │                 │   xxx123 → ✅        │                         │
│      │                 │                      │                         │
│      │                 │ ② Client 식별       │                         │
│      │                 │   xxx123 → "dept-a" │                         │
│      │                 │                      │                         │
│      │                 │ X-Client-ID: dept-a  │                         │
│      │                 │─────────────────────▶│                         │
│      │                 │                      │                         │
│      │                 │                      │ ③ 신뢰하고 사용        │
│      │                 │                      │   - 감사 로그 기록     │
│      │                 │                      │   - 사용량 추적        │
│      │                 │                      │                         │
│                                                                          │
│   ─────────────────────────────────────────────────────────────────     │
│                                                                          │
│   Backend의 X-Client-ID 사용 범위:                                      │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │  ✅ 사용 가능                    ❌ 사용 금지               │      │
│   │  ───────────────                 ─────────────              │      │
│   │  • 감사 로그 기록                • 인가(Authorization)      │      │
│   │  • 사용량 집계                   • 접근 제어                │      │
│   │  • 요청 추적                     • 민감 데이터 분기         │      │
│   │                                                              │      │
│   │  → 현 단계에서 세분화된 인가는 불필요                        │      │
│   │  → 추후 필요 시 별도 ADR로 정의                              │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**신뢰 기반:**

| 항목 | 설명 |
|------|------|
| **신뢰 조건** | X-Client-ID는 Nginx가 주입한 것만 유효 |
| **보안 전제** | 외부에서 직접 Backend 접근 불가 (ADR-001) |
| **위변조 방지** | Nginx가 요청의 기존 X-Client-ID 헤더 제거 |

---

## 3. 아키텍처 개요

### 3.1 보안 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         보안 아키텍처 전체도                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  [Untrusted Zone]                                                        │
│  ─────────────────                                                       │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │ Dept-A       │  │ Dept-B       │  │ External     │                  │
│  │ Server       │  │ Server       │  │ Partner      │                  │
│  │ (API Key: A) │  │ (API Key: B) │  │ (API Key: C) │                  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                  │
│         │                 │                 │                           │
│         └─────────────────┴─────────────────┘                           │
│                           │                                              │
│                           │ Authorization: Bearer <Key>                 │
│                           ▼                                              │
│  ═══════════════════════════════════════════════════════════════════    │
│                           │                                              │
│  [Edge Layer - Nginx]     │                                              │
│  ─────────────────────    │                                              │
│  ┌────────────────────────┴────────────────────────────────────────┐    │
│  │                                                                  │    │
│  │  ① TLS Termination ─────────────────────────────────────────┐   │    │
│  │     └─ HTTPS 복호화, 인증서 검증                             │   │    │
│  │                                                               │   │    │
│  │  ② API Key Validation ───────────────────────────────────┐  │   │    │
│  │     ├─ Key 유효성 검증                                    │  │   │    │
│  │     ├─ 미인증 요청 → 401 Unauthorized                     │  │   │    │
│  │     └─ Key-Client 매핑 조회                               │  │   │    │
│  │                                                            │  │   │    │
│  │  ③ Identity Injection ─────────────────────────────────┐ │  │   │    │
│  │     ├─ 기존 X-Client-ID 헤더 제거 (위변조 방지)         │ │  │   │    │
│  │     └─ 검증된 Client ID 주입                            │ │  │   │    │
│  │                                                          │ │  │   │    │
│  │  ④ Rate Limiting ────────────────────────────────────┐│ │  │   │    │
│  │     └─ Client별 요청 속도 제한                        ││ │  │   │    │
│  │                                                        ││ │  │   │    │
│  └────────────────────────────────────────────────────────┘│ │  │   │    │
│                                                              │ │  │   │    │
│  ═══════════════════════════════════════════════════════════│═│══│═══    │
│                           │                                  │ │  │      │
│  [Trusted Zone]           │ X-Client-ID: <verified_id>       │ │  │      │
│  ──────────────           ▼                                  ▼ ▼  ▼      │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │   Application Layer (FastAPI)                                    │    │
│  │   ─────────────────────────────                                  │    │
│  │                                                                   │    │
│  │   • 인증 로직 없음 (Edge에서 처리 완료)                          │    │
│  │   • X-Client-ID 헤더 신뢰                                        │    │
│  │   • 비즈니스 로직에만 집중                                       │    │
│  │                                                                   │    │
│  │   ┌─────────────────────────────────────────────────────────┐   │    │
│  │   │  Audit Log: { client_id, timestamp, action, result }    │   │    │
│  │   └─────────────────────────────────────────────────────────┘   │    │
│  │                                                                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 인증 흐름 요약

| 단계 | 수행 주체 | 동작 |
|------|----------|------|
| 1 | Client | `Authorization: Bearer <API_KEY>` 헤더 포함하여 요청 |
| 2 | Nginx | API Key 유효성 검증 |
| 3 | Nginx | 무효한 Key → 401 Unauthorized 반환 |
| 4 | Nginx | 유효한 Key → Client ID 조회 |
| 5 | Nginx | X-Client-ID 헤더 주입 후 Backend로 프록시 |
| 6 | FastAPI | X-Client-ID 신뢰, 감사 로그 기록 |

---

## 4. 트레이드오프 및 제약

### 4.1 감수하는 단점

| 단점 | 영향 | 보완 전략 |
|------|------|----------|
| **토큰 로테이션 수동** | Key 변경 시 클라이언트 재설정 필요 | 분기별 로테이션 스케줄, 충분한 사전 공지 |
| **세분화된 인가 없음** | 모든 인증된 클라이언트가 동일 권한 | 현 단계에서 불필요, 추후 RBAC 도입 시 별도 ADR |
| **OAuth2 대비 기능 제한** | Refresh Token, Scope 등 미지원 | Machine Client에는 불필요한 기능 |
| **Key 유출 리스크** | 장기 유효 Key는 유출 시 위험 | 즉시 무효화 절차, IP 화이트리스트 병행 고려 |

### 4.2 mTLS 옵션

> **선택적 강화**: 보안 요구사항이 매우 높은 특정 채널에만 mTLS(상호 인증)를 적용할 수 있다.

| 적용 조건 | 설명 |
|----------|------|
| **규제 요건** | 금융, 의료 등 특수 규제 대상 데이터 처리 시 |
| **외부 파트너** | 외부 네트워크에서 접근하는 파트너 시스템 |
| **민감 데이터** | 특정 API 엔드포인트가 민감 데이터를 다룰 때 |

```
mTLS 도입 시:
- 클라이언트 인증서 발급/관리 절차 필요
- PKI 인프라 구축 또는 기존 사내 CA 활용
- 구현 복잡도 증가
- 별도 ADR로 상세 정의 권장
```

### 4.3 재검토 트리거

다음 상황 발생 시 이 결정을 재검토한다:

- [ ] End User(사람) 직접 접근 필요성 발생
- [ ] 클라이언트 수 50개 이상 증가
- [ ] 세분화된 인가(RBAC/ABAC) 필요성 발생
- [ ] 외부 IdP(Identity Provider) 연동 요구
- [ ] API Key 유출 사고 발생

---

## 5. 결론

### 5.1 최종 결정 요약

| 결정 항목 | 결정 내용 | 핵심 논거 |
|----------|----------|----------|
| **인증 책임 위치** | Edge Layer (Nginx) | 성능, Defense in Depth, 관심사 분리 |
| **인증 메커니즘** | Static API Key (Bearer) | Machine-to-Machine 적합성, 구현 단순성 |
| **신원 전파 방식** | X-Client-ID 헤더 | 감사 로그 용도, Backend 신뢰 기반 |
| **고급 보안 옵션** | mTLS (선택적) | 고보안 채널에만 적용 |

### 5.2 핵심 메시지

> **"보안을 포기한 것이 아니라, 보안 책임을 Edge로 옮기고 최적화한 것이다."**

이 결정은:
- Backend에서 인증 로직을 제거하여 **비즈니스 로직을 순수하게** 유지한다
- Nginx의 고성능 인증 처리로 **잘못된 요청을 조기 차단**한다
- 복잡한 토큰 서버 없이 **"충분히 안전한" 보안 체계**를 달성한다
- Machine-to-Machine 통신에 적합한 **실용적인 인증 방식**을 채택한다

---

## 관련 문서 (Related)

**선행 결정:**
- [ADR-001: AI 서비스 엔드포인트 노출 방법 (Nginx OSS)](./001_How_to_Securely_Expose_AI_API_Endpoint_[Nginx%20OSS].md) — Edge Layer 도입 및 PEP 역할 정의

**설계/운영 문서:**
- [02_architecture/03_gateway.md](../02_architecture/03_gateway.md) — Nginx 설정 상세 (API Key 검증 구현)
- [04_operations/02_deployment.md](../04_operations/02_deployment.md) — API Key 발급 및 로테이션 절차

---

## 변경 이력 (Changelog)

| 날짜 | 작성자 | 변경 내용 |
|------|--------|----------|
| 2024-12-28 | System Architect | 초안 작성 |
