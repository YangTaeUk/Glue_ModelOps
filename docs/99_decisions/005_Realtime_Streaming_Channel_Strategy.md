# ADR-005: Dual Path 구현 및 클라이언트 통신 채널 전략

> **Status**: Accepted
> **Date**: 2024-12-27
> **Author**: System Architect
> **Context**: ADR-003(Temporal 채택, Dual Path 원칙) 후속 결정 — 구현 전략 구체화
> **Supersedes**: N/A

---

## TL;DR (한 줄 요약)

> 클라이언트 통신 방식(HTTP/SSE/WebSocket)은 **제한하지 않으며**, 내부 데이터 경로(Temporal/Direct)는 **데이터 특성에 따라 시스템이 결정**한다. 두 관심사는 독립적이다.

---

## 1. 문제 정의: 두 가지 상충하는 요구사항

### 1.1 요구사항 충돌

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   상충하는 요구사항                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   [요구사항 1] 통신 방식 유연성                                         │
│   ─────────────────────────────                                         │
│                                                                          │
│   "각 구간별 통신 방식에 제한을 두면 안 된다"                           │
│                                                                          │
│   이유:                                                                  │
│   • 통신 방식이 정해지면 제공 가능한 기능/모델의 제한이 커짐             │
│   • 클라이언트 환경에 따라 최적의 통신 방식이 다름                       │
│   • 향후 요구사항 변화에 유연하게 대응해야 함                            │
│                                                                          │
│   ─────────────────────────────────────────────────────────────────      │
│                                                                          │
│   [요구사항 2] Temporal 채택                                             │
│   ────────────────────────                                               │
│                                                                          │
│   "상태 관리와 내구성을 위해 Temporal을 사용한다" (ADR-003)             │
│                                                                          │
│   그러나 Temporal에는 구조적 한계가 있다:                                │
│   • Payload 2MB 제한                                                     │
│   • 모든 이벤트 DB 기록 (고빈도 이벤트에 부적합)                         │
│   • 지연 오버헤드 (DB 트랜잭션)                                          │
│                                                                          │
│   ─────────────────────────────────────────────────────────────────      │
│                                                                          │
│   [충돌 지점]                                                            │
│                                                                          │
│   통신 유연성을 유지하면서 Temporal 한계를 어떻게 우회할 것인가?        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 해결 전략: 관심사 분리

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   핵심 통찰: 두 관심사는 독립적이다                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────────────────┐    ┌─────────────────────────┐            │
│   │  관심사 1:              │    │  관심사 2:              │            │
│   │  클라이언트 통신 방식   │    │  내부 데이터 경로       │            │
│   │  ─────────────────────  │    │  ─────────────────────  │            │
│   │                         │    │                         │            │
│   │  무엇을: 클라이언트와   │    │  무엇을: 내부 컴포넌트  │            │
│   │         어떻게 대화할지 │    │         간 데이터 흐름  │            │
│   │                         │    │                         │            │
│   │  선택 주체: 클라이언트  │    │  선택 주체: 시스템      │            │
│   │                         │    │                         │            │
│   │  기준: 비즈니스 요구    │    │  기준: 데이터 특성      │            │
│   │        클라이언트 환경  │    │        (크기/빈도/지연) │            │
│   └─────────────────────────┘    └─────────────────────────┘            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Dual Path 전략

### 2.1 경로 정의

| 경로 | 용도 | 적합한 데이터 | 특성 |
|------|------|--------------|------|
| **Path 1: Temporal** | 오케스트레이션, 상태 관리, 장애 복구 | Job 상태, 단계 전환, 감사 이벤트 | 내구성 보장, 지연 있음 |
| **Path 2: Direct** | Temporal 한계 우회, 고성능 전달 | 대용량 데이터, 고빈도 이벤트, 저지연 요구 | 자체 내구성 필요 (선택적) |

### 2.2 경로 선택 기준

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   데이터 특성에 따른 경로 선택                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   [판단 기준]                                                            │
│                                                                          │
│   • 크기 > 2MB?           → Path 2 (참조만 Temporal로)                  │
│   • 빈도 > 10 events/sec? → Path 2 (집계만 Temporal로)                  │
│   • 지연 < 100ms 필요?    → Path 2 (결과만 Temporal로)                  │
│   • 내구성/복구 필요?     → Path 1                                      │
│                                                                          │
│   ─────────────────────────────────────────────────────────────────      │
│                                                                          │
│   [예시 — 모델 유형에 무관하게 적용]                                     │
│                                                                          │
│   데이터/이벤트               경로        이유                           │
│   ─────────────               ─────       ─────                          │
│   Job 시작/완료 이벤트        Path 1      상태 추적, 내구성 필요         │
│   단계 성공/실패              Path 1      재시도 정책 적용               │
│   대용량 입력 (이미지, 오디오) Path 2      2MB 초과, 참조만 전달          │
│   대용량 출력 (생성 결과)      Path 2      2MB 초과 가능                  │
│   스트리밍 청크 (점진적 응답)  Path 2      고빈도, 저지연 필요            │
│   실시간 진행률               Path 2      저지연 필요                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 두 경로 간 동기화 원칙

> **"Path 2로 전달된 데이터도 Temporal이 '알아야' 하는 경우, Sync Point를 통해 동기화한다."**

| 패턴 | 설명 |
|------|------|
| **시작/종료 마커** | Path 2 데이터 전송의 시작/종료는 Path 1에 기록 |
| **집계 패턴** | 다수의 Path 2 이벤트를 집계하여 Path 1에 요약 기록 |
| **참조(Reference) 패턴** | 대용량 데이터는 외부 저장, 참조(URL/Key)만 Temporal로 전달 |

### 2.4 Claim Check Pattern (대용량 데이터)

> **"대용량 데이터는 외부 저장소에 저장하고, 참조(key/URL)만 Temporal을 통해 전달한다."**
> — Temporal 공식 권장 패턴

| 적용 기준 | 처리 방식 |
|----------|----------|
| 1.5MB 초과 | 무조건 Claim Check 적용 |
| 1MB~1.5MB | 누적 고려하여 선택적 적용 |
| 1MB 미만 | 직접 전달 허용 (단, 빈도 고려) |

---

## 3. 클라이언트 통신 방식 (제한 없음)

### 3.1 지원하는 통신 방식

| 방식 | 동작 | 적합한 경우 |
|------|------|------------|
| **동기 HTTP** | 요청 → 완료 대기 → 전체 응답 | 짧은 작업, 단순 통합 |
| **비동기 HTTP** | 요청 → Job ID 즉시 발급 → Polling/Webhook | 장시간 작업, M2M 통신 |
| **SSE** | 연결 유지 → 서버 이벤트 푸시 | 점진적 응답, 실시간 진행률 |
| **WebSocket** | 양방향 연결 → 실시간 메시지 교환 | 양방향 통신, 인터랙티브 세션 |

### 3.2 핵심 원칙

> **"통신 방식은 클라이언트가 선택한다. 시스템은 모든 방식을 동등하게 지원한다."**

- 어떤 통신 방식을 사용하든 동일한 파이프라인 실행
- 통신 채널과 비즈니스 로직의 분리
- 새로운 통신 방식 추가 시 파이프라인 코드 변경 없음

### 3.3 통신 방식과 내부 경로의 독립성

```
┌─────────────────────────────────────────────────────────────────────────┐
│   어떤 클라이언트 통신 방식을 사용하든, 내부적으로는                    │
│   데이터 특성에 따라 Path 1 또는 Path 2를 사용한다.                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                         │  Path 1      │  Path 2                        │
│                         │  (Temporal)  │  (Direct)                      │
│   ──────────────────────┼──────────────┼────────────────                │
│   동기 HTTP             │  상태 저장   │  대용량 결과                   │
│   비동기 HTTP           │  Job 상태    │  결과 파일                     │
│   SSE                   │  시작/종료   │  스트리밍 청크                 │
│   WebSocket             │  세션 상태   │  실시간 메시지                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 기술 선택 원칙

> **ADR은 "무엇을" 결정하고, "어떻게"는 설계 문서로 위임한다.**

### 4.1 Path 2 저장소 선택 원칙

| 배포 환경 | 권장 저장소 | 선택 근거 |
|----------|------------|----------|
| **단일 노드** | Local Storage (공유 볼륨) | 네트워크 오버헤드 없음, 최고 성능 |
| **다중 노드** | Object Storage (S3 호환) | 노드 간 공유 필요 |
| **하이브리드** | Local + Object Storage | 핫 데이터는 로컬, 콜드 데이터는 오브젝트 |

**구체적 기술 선택(MinIO, S3, NFS 등)은 설계 문서에서 결정**

### 4.2 Path 2 메시징 선택 원칙

| 요구사항 | 권장 방식 | 선택 근거 |
|---------|----------|----------|
| **재연결 시 복구 필요** | 영속성 있는 스트림 | 메시지 유실 방지 |
| **순수 실시간 알림** | Fire-and-forget 채널 | 극저지연, 유실 허용 |
| **복잡한 라우팅** | 메시지 브로커 | 토픽/큐 기반 분배 |

**구체적 기술 선택(Redis Streams, Kafka, NATS 등)은 설계 문서에서 결정**

### 4.3 클라이언트 통신 방식 선택 메커니즘

| 결정 항목 | 원칙 |
|----------|------|
| **선택 방식** | HTTP 표준 협상 (Accept Header, Upgrade 등) |
| **기본값** | 비동기 HTTP (Job ID 발급) — 가장 범용적 |
| **스트리밍 기본** | SSE — HTTP 호환성, 자동 재연결 |

---

## 5. 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       전체 데이터 흐름                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   [클라이언트]                                                          │
│       │                                                                  │
│       │  통신 방식 선택 (HTTP / SSE / WebSocket)                        │
│       ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Edge Layer (Nginx) — ADR-001                                    │   │
│   └───────────────────────────┬─────────────────────────────────────┘   │
│                               │                                          │
│                               ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  API Gateway                                                     │   │
│   │  • Temporal Workflow 시작                                        │   │
│   │  • 클라이언트 연결 관리                                          │   │
│   │  • Path 1 ↔ Path 2 이벤트 통합                                  │   │
│   └───────────────────────────┬─────────────────────────────────────┘   │
│                               │                                          │
│               ┌───────────────┴───────────────┐                         │
│               ▼                               ▼                         │
│   ┌───────────────────────┐       ┌───────────────────────┐             │
│   │  Path 1: Temporal     │       │  Path 2: Direct       │             │
│   │  ──────────────────   │       │  ──────────────────   │             │
│   │  • 상태 영속화        │       │  • 외부 저장소        │             │
│   │  • 장애 복구          │       │  • 메시지 채널        │             │
│   └───────────────────────┘       └───────────────────────┘             │
│               │                               │                         │
│               │         [Sync Point]          │                         │
│               └───────────────┬───────────────┘                         │
│                               │                                          │
│                               ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  Worker — ADR-006                                                │   │
│   │  • Connector를 통한 모델 통신 — ADR-004                          │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 트레이드오프

### 6.1 감수하는 복잡도

| 복잡도 | 영향 | 보완 방안 |
|--------|------|----------|
| **두 경로 관리** | 데이터 흐름 파악 어려움 | 명확한 라우팅 규칙, 로깅 |
| **동기화 로직** | 일관성 유지 코드 필요 | 동기화 패턴 표준화 |
| **다중 프로토콜** | 테스트 복잡도 증가 | 프로토콜별 테스트 자동화 |

### 6.2 재검토 트리거

- [ ] Path 2 관리 복잡도가 과도해질 때
- [ ] 동기화 실패로 인한 데이터 불일치 빈발 시
- [ ] 특정 통신 방식의 사용률이 극히 낮을 때
- [ ] Temporal의 한계가 완화될 때 (버전 업그레이드 등)

---

## 7. 결론

### 7.1 최종 결정 요약

| 결정 항목 | 결정 내용 | 핵심 논거 |
|----------|----------|----------|
| **관심사 분리** | 통신 방식과 데이터 경로를 독립적으로 처리 | 유연성 확보, 관심사 혼재 방지 |
| **통신 방식** | 제한 없음 — 클라이언트가 선택 | 비즈니스 유연성, 모델 유형에 무관 |
| **데이터 경로** | Dual Path — 데이터 특성에 따라 라우팅 | Temporal 한계 우회, 성능 최적화 |
| **저장소** | 배포 환경에 따라 선택 (단일: Local, 다중: Object) | 성능과 확장성 균형 |
| **동기화** | Sync Point 패턴으로 일관성 유지 | 두 경로 간 상태 동기화 |

### 7.2 핵심 메시지

> **"Dual Path는 Temporal의 한계를 우회하기 위한 데이터 경로 분리이다. 클라이언트 통신 방식 선택과는 독립적이며, 모델 유형에 관계없이 동일한 원칙이 적용된다."**

---

## 관련 문서 (Related)

**선행 결정:**
- [ADR-001: Edge Layer (Nginx)](./001_How_to_Securely_Expose_AI_API_Endpoint_[Nginx%20OSS].md) — 다중 프로토콜 지원
- [ADR-002: AI 백엔드 범위 및 아키텍처 스타일](./002_Defining_Scope_and_Architecture_Style_of_AI_Backend_Application.md) — 파이프라인 구조 정의, Context Propagation
- [ADR-003: 추론 작업 실행 모델](./003_Inference_Task_Execution_Model_and_State_Management_Strategy.md) — Temporal 채택, Dual Path 원칙 도입
- [ADR-004: Universal Connector](./004_Universal_Connector_Strategy_for_Model_Integration.md) — 백엔드 통신 추상화

**관련 결정:**
- [ADR-006: Worker 리소스 분리](./006_Worker_Resource_Separation_and_Parallel_Processing_Strategy.md) — Worker 구성, 단계 간 데이터 전달

---

## 참고 자료 (References)

### Temporal 공식 문서
- [Temporal Blob Size Limit Error](https://docs.temporal.io/troubleshooting/blob-size-limit-error) — Claim Check Pattern 권장
- [Temporal Cloud System Limits](https://docs.temporal.io/cloud/limits) — Payload 2MB, History 50MB 제한

### 스트리밍 아키텍처
- [Redis Streams Documentation](https://redis.io/docs/latest/develop/data-types/streams/) — 영속성 있는 메시지 스트리밍
- [Event-Driven Architecture Patterns](https://microservices.io/patterns/data/event-driven-architecture.html) — 이벤트 기반 설계

---

## 변경 이력 (Changelog)

| 날짜 | 작성자 | 변경 내용 |
|------|--------|----------|
| 2024-12-27 | System Architect | 초안 작성 — 결정 필요 사항 목록화 |
| 2024-12-27 | System Architect | 범위 확장 — SSE 전용에서 다중 클라이언트 통신 방식으로 변경 |
| 2024-12-27 | System Architect | Dual Path 재정의 — 관심사 분리, 데이터 경로와 통신 방식 독립성 명확화 |
| 2024-12-27 | System Architect | Model-Agnostic 리팩토링 — LLM 편향 제거, 저장소 환경별 선택 원칙, 과도한 기술 상세 제거 |
